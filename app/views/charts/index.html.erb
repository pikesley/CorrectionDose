<%= render partial: 'shared/add_links' %>  

<div class='chart-hours'>
  <%= render partial: 'shared/hours_picker' %>
  | <%= link_to 'Data', "#{root_path}?#{request.query_string}", title: 'Home' %>
</div>

<div id='chart' class='chart'></div>

<script>
  $.getJSON(document.URL, function(json) {
    graph(json)
  })

  function ecks(json) {
    'datetime'
  }

  function why(json) {
    'value'
  }

  function mapPoints(json, axis) {
    return json.map(function(item){ return item[axis] })
  }

  function fixTimeStamps(data) {
    return data.map(function(date){ return date.replace('T', ' ').replace('.000Z', '') })
  }

  function points(json, y_field) {
    return {
      x: fixTimeStamps(mapPoints(json, 'datetime')),
      y: mapPoints(json, y_field)
    }
  }

  function graph(json) {
    var bg = {
      x: points(json['glucose'], 'value')['x'],
      y: points(json['glucose'], 'value')['y'],
      type: 'scatter',
      name: 'Glucose'
    }

    var meds = {
      x: points(json['meds'], 'dose')['x'],
      y: points(json['meds'], 'dose')['y'],
      mode: 'markers', //+text',
    //  textposition: 'top right',
      name: 'Meds',
      text: json['meds'].map(function(item){ return item['insulin'] } )
    }

    var carbs = {
      x: points(json['carbs'], 'weight')['x'],
      y: points(json['carbs'], 'weight')['y'],
      mode: 'markers', //+text',
    //  textposition: 'top right',
      name: 'Carbs'
    }

    var layout = {
      xaxis: {
        type: 'datetime',
        tickangle: 315,
        tickformat: "%a %H:%M"
      },
      yaxis: {
        title: 'mmol/L',
        titlefont: {
          size: 14,
          color: '#7f7f7f'
        }
      },
      margin: {
        l: 40, r: 10
      },
      legend: {
        xanchor:"center",
        yanchor:"top",
        y:-0.3, // play with it
        x:0.5   // play with it
      }
    }

    datas = [bg, meds, carbs]

    Plotly.newPlot('chart', datas, layout, { displayModeBar: false })
  }
</script>
